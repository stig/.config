#+title: LilyPond
#+AUTHOR: Stig Brautaset
#+OPTIONS: f:t
#+PROPERTY: header-args:              :mkdirp yes
#+PROPERTY: header-args:emacs-lisp    :tangle ~/.emacs.d/lilypond.el :results silent
#+STARTUP: content

LilyPond is a music transcription software.

* Installation

I install LilyPond via a download from https://lilypond.org.

* Configuration

   #+begin_src emacs-lisp
     (use-package lilypond-mode
       :load-path "/Applications/LilyPond.app/Contents/Resources/share/emacs/site-lisp"
       :mode (("\\.ily\\'" . LilyPond-mode)
	      ("\\.ly\\'" . LilyPond-mode))
       :hook (LilyPond-mode . (lambda () (turn-on-font-lock)))
       :custom
       (LilyPond-midi-command "playmidi" t)
       (LilyPond-pdf-command "open"))
   #+end_src

* Creating the =playmidi= shell script

We can play midi files with fluidsynth, but the invocation isn't
the nicest.  I wrap it in a shell script.  First I have to install
it, however.

#+begin_src emacs-lisp
  (use-package fluidsynth
    :ensure nil
    :no-require t
    :ensure-system-package fluidsynth)
#+end_src

Then we need a soundfont. Fluidsynth appears to recommend the one from
http://www.schristiancollins.com/generaluser.php.

#+begin_src sh :tangle "~/.local/bin/download_soundfont" :tangle-mode (identity #o755) :mkdirp t
  #!/bin/bash
  set -o errexit
  set -o nounset
  set -o pipefail

  tempfoo=`basename $0`
  TMPDIR=`mktemp -d -t ${tempfoo}`

  VERSION="1.471"

  mkdir -p ~/.local/share
  TARGET=~/.local/share/GeneralUserGS
  if test -d $TARGET ; then
      mv $TARGET $TARGET.$(date +%Y-%m-%d).$RANDOM
  fi

  DL=GeneralUser_GS_$VERSION
  curl -L https://www.dropbox.com/s/4x27l49kxcwamp5/GeneralUser_GS_$VERSION.zip?dl=1 -o ~/Downloads/$DL.zip
  cd $TMPDIR
  unzip ~/Downloads/$DL.zip

  mv "$(find $TMPDIR -mindepth 1 -maxdepth 1 -type d)" "$TARGET"

  rmdir $TMPDIR
#+end_src

Finally let's install a wrapper to more easily play stuff.

#+begin_src sh :tangle "~/.local/bin/playmidi" :tangle-mode (identity #o755)
  #!/bin/bash
  set -o errexit
  set -o nounset
  set -o pipefail

  if ! test -d ~/.local/share/GeneralUserGS ; then
    echo "No soundfonts found, attempting to download..."
    download_soundfont
  fi

  fluidsynth -a coreaudio -m coremidi -ni ~/.local/share/GeneralUserGS/GeneralUser\ GS\ v1.471.sf2 "$@"
#+end_src

