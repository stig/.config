#+title: Notmuch

I currently use [[https://notmuchmail.org][Notmuch]] for reading and sending Email, as it has a
nice Emacs client.

* Configuring Notmuch

#+begin_src conf :tangle ~/.notmuch-config
[database]
path=/Users/stig/.mail

[user]
name=Stig Brautaset
primary_email=stig@brautaset.org
other_email=stig@circleci.com

[new]
tags=new;unread;inbox
ignore=.mbsyncstate;.mbsyncstate.journal;.mbsyncstate.lock;.mbsyncstate.new;.uidvalidity;.isyncuidmap.db;.DS_Store

[search]
exclude_tags=deleted;spam;muted

[maildir]
synchronize_flags=true
#+end_src

* Script to run immediately before checking for new mail

Remove the =new= tag from any messages just before refreshing. Do this
in a =pre-hook= so we can use the new =new= tag to optimise further
tagging in the =post-hook= below.

#+BEGIN_SRC sh :tangle "~/.mail/.notmuch/hooks/pre-new" :shebang #!/bin/zsh :tangle-mode (identity #o755) :mkdirp t
set -euo pipefail
IFS=$'\n\t'

# Make sure we have up-to-date paths
notmuch new --no-hooks

notmuch tag -new -- tag:new

# Delete deleted drafts immediately
notmuch search --output=files --format=text0 -- tag:deleted and tag:draft | xargs -0 rm || true

# Delete old mail
notmuch search --output=files --format=text0 -- tag:deleted and date:..4w | xargs -0 rm || true

# Move spam
notmuch search --output=files --format=text0 -- path:"gandi/INBOX/**" and tag:spam | xargs -0tI {} mv -n {} ~/.mail/gandi/Junk/new/

# Make sure we have up-to-date paths, again
notmuch new --no-hooks
#+END_SRC

* Script to run immediately after checking for new mail

Notmuch assigns the =new= tag when it first sees a message, so we
can use it to limit the search space for further tagging.

#+BEGIN_SRC sh :tangle "~/.mail/.notmuch/hooks/post-new" :shebang #!/bin/zsh :tangle-mode (identity #o755) :mkdirp t
notmuch tag --batch <<EOF
# Mute new messages to muted threads.
+muted -- tag:new thread:{tag:muted}

# Tag sent mail & remove from inbox
-inbox -unread +sent -- tag:new path:"gandi/Sent/**" or path:"gmail/[Gmail]/Sent Mail/**"

-inbox +spam         -- tag:new path:"gandi/Junk/**"
-inbox +archived     -- tag:new path:"gandi/Archive/**"
+deleted -- tag:new path:"gandi/Trash/**" path:"gmail/[Gmail]/Trash/**"

+gandi    -- path:"gandi/**"
+circleci -- path:"gmail/**"

# Add specific tags for mailing lists, and remove from inbox
+lists +org-mode -inbox -- tag:new to:emacs-orgmode@gnu.org
+lists +clojure -inbox  -- tag:new to:clojure@googlegroups.com

# V. low volume lists gets to stay in inbox
+lists +tuls -- tag:new to:tuls@debussy.pauken.co.uk

# Tag various common senders
+lobsters    -- tag:new from:nobody@lobste.rs
+github      -- tag:new from:notifications@github.com
+jira 	     -- tag:new from:jira@circleci.atlassian.net
+pagerduty   -- tag:new from:no-reply@pagerduty.com
+linkedin    -- tag:new from:messaging-digest-noreply@linkedin.com
+patreon     -- tag:new from:bingo@patreon.com
+guitarhacks -- tag:new from:support@guitarhacks.com
+amazon      -- tag:new from:no-reply-aws@amazon.com

# Tag *very persistent* spammers
+spam -inbox -- tag:new from:alexandre@les-caves.fr
EOF
#+END_SRC
